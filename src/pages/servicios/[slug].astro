---
// src/pages/servicios/[slug].astro
import PageLayout from '@/layouts/PageLayout.astro';
import { supabase } from '@/lib/supabase'; // ✅ Usamos Supabase
import { ICON_MAP, type IconName } from '@/utils/constants'; // Solo iconos
import Button from '@/components/ui/Button.astro';
import { CheckCircle2, ArrowLeft, Calendar, Users } from 'lucide-react';
import { formatCurrency } from '@/utils/formatters';
import type { Service } from '@/types';

// 1. GENERACIÓN DE RUTAS DINÁMICAS DESDE SUPABASE
export async function getStaticPaths() {
  const { data: services } = await supabase
    .from('services')
    .select('*')
    .eq('active', true);

  return (services || []).map((service) => ({
    params: { slug: service.slug },
    props: { service: service as unknown as Service },
  }));
}

// 2. RECUPERAR DATOS DEL SERVICIO
const { service } = Astro.props;

// Recuperar Icono dinámico
const Icon = ICON_MAP[service.icon as IconName] || ICON_MAP.Martini;

// 3. MAPA DE RESPALDO (FALLBACK)
// Usamos esto solo si la BD tiene campos vacíos (mientras terminas de llenar el admin)
const fallbackDetails: Record<string, any> = {
  'bartending-eventos': {
    longDesc: "Nuestro servicio insignia diseñado para bodas, aniversarios y celebraciones sociales. Nos encargamos de transformar tu barra en el punto focal de la fiesta con un servicio impecable y cócteles que tus invitados recordarán.",
    idealFor: ["Bodas y Matrimonios", "Cumpleaños (30, 40, 50)", "Aniversarios", "Eventos Privados"],
    includes: ["Cristalería premium completa", "Hielo y todos los insumos", "Limpieza y gestión de residuos"],
    image: "/images/services-hero.png" 
  },
  // ... puedes dejar el resto del mapa aquí si quieres mantener compatibilidad histórica
};

// 4. LÓGICA DE DATOS FINALES (BD > Fallback)
// Si la BD tiene 'long_description', úsala. Si no, busca en el mapa.
const fallbackItem = fallbackDetails[service.slug] || fallbackDetails['bartending-eventos'];

const longDescription = service.long_description || fallbackItem?.longDesc || service.description;
const heroImage = service.image_url || fallbackItem?.image || "/images/services-hero.png";

// Para arrays como 'idealFor' o 'includes' adicionales, 
// como no están en tu tabla actual de services (solo features),
// usaremos los del fallback o dejaremos arrays vacíos por defecto.
// *Nota: Sería ideal agregar columnas 'ideal_for' (text[]) a tu tabla en el futuro.
const idealFor = fallbackItem?.idealFor || []; 
const extraIncludes = fallbackItem?.includes || [];
---

<PageLayout title={`${service.name} | La Reserva`} description={service.description}>
  
  {/* HERO SECTION */}
  <section class="relative h-[50vh] min-h-[400px] flex items-center justify-center overflow-hidden bg-secondary-900">
    <div class="absolute inset-0 z-0">
      <img src={heroImage} alt={service.name} class="w-full h-full object-cover opacity-50" />
      <div class="absolute inset-0 bg-gradient-to-t from-secondary-900 via-secondary-900/60 to-transparent"></div>
    </div>

    <div class="relative z-10 container-custom text-center">
      <div class="inline-flex p-4 rounded-full bg-primary-500/20 text-primary-400 mb-6 backdrop-blur-sm border border-primary-500/30">
        <Icon className="w-8 h-8" />
      </div>
      <h1 class="text-4xl md:text-6xl font-display font-bold text-white mb-4">
        {service.name}
      </h1>
      <p class="text-xl text-secondary-200 max-w-2xl mx-auto">
        {service.description}
      </p>
    </div>
  </section>

  {/* CONTENIDO DETALLADO */}
  <section class="section bg-white">
    <div class="container-custom">
      
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        
        {/* Columna Izquierda: Información (8 cols) */}
        <div class="lg:col-span-8 space-y-12">
          
          {/* Descripción Larga */}
          <div>
            <h2 class="text-2xl font-display font-bold text-secondary-900 mb-4">Sobre el Servicio</h2>
            <p class="text-lg text-secondary-600 leading-relaxed whitespace-pre-line">
              {longDescription}
            </p>
          </div>

          {/* Lo que incluye */}
          <div class="bg-secondary-50 p-8 rounded-2xl border border-secondary-100">
            <h3 class="text-xl font-bold text-secondary-900 mb-6">¿Qué incluye esta experiencia?</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              
              {/* Features desde la BD (tabla services -> columna features) */}
              {service.features && service.features.map(feature => (
                <div class="flex items-start gap-3">
                  <CheckCircle2 className="w-5 h-5 text-primary-500 mt-0.5 flex-shrink-0" />
                  <span class="text-secondary-700">{feature}</span>
                </div>
              ))}

              {/* Features extra (Fallback) */}
              {extraIncludes.map((item: string) => (
                <div class="flex items-start gap-3">
                  <CheckCircle2 className="w-5 h-5 text-primary-500 mt-0.5 flex-shrink-0" />
                  <span class="text-secondary-700">{item}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Ideal Para (Solo se muestra si hay datos) */}
          {idealFor.length > 0 && (
            <div>
              <h3 class="text-xl font-bold text-secondary-900 mb-6">Ideal para</h3>
              <div class="flex flex-wrap gap-3">
                {idealFor.map((tag: string) => (
                  <span class="px-4 py-2 bg-white border border-secondary-200 rounded-full text-secondary-600 text-sm font-medium shadow-sm">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
          )}

        </div>

        {/* Columna Derecha: Sidebar Sticky (4 cols) */}
        <div class="lg:col-span-4">
          <div class="sticky top-24 bg-white border border-secondary-200 rounded-2xl p-6 shadow-lg">
            <div class="text-center mb-6 pb-6 border-b border-secondary-100">
              <p class="text-sm text-secondary-500 uppercase tracking-wider mb-2">Inversión desde</p>
              <p class="text-4xl font-bold text-primary-600">{formatCurrency(service.price_from)}</p>
            </div>

            <div class="space-y-4 mb-8">
              {/* ✅ AHORA SÍ USAMOS LOS DATOS DE LA BD */}
              <div class="flex items-center gap-3 text-secondary-600">
                <Users className="w-5 h-5 text-primary-500" />
                <span class="text-sm">Capacidad: <strong>{service.guest_range || 'Consultar'} invitados</strong></span>
              </div>
              <div class="flex items-center gap-3 text-secondary-600">
                <Calendar className="w-5 h-5 text-primary-500" />
                <span class="text-sm">Duración base: <strong>{service.duration || 4} horas</strong></span>
              </div>
            </div>

            <Button href="/cotizacion" variant="primary" fullWidth class="mb-4">
              Cotizar este Servicio
            </Button>
            
            <Button href="/servicios" variant="outline" fullWidth class="border-secondary-200 text-secondary-600">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Ver otros servicios
            </Button>
          </div>
        </div>
      </div>

    </div>
  </section>

</PageLayout>