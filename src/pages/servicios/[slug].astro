---
// src/pages/servicios/[slug].astro
import PageLayout from '@/layouts/PageLayout.astro';
import { supabase } from '@/lib/supabase';
import { ICON_MAP, type IconName } from '@/utils/constants';
import Button from '@/components/ui/Button.astro';
import { CheckCircle2, ArrowLeft, Calendar, Users } from 'lucide-react';
import { formatCurrency } from '@/utils/formatters';
import type { Service } from '@/types';

// 1. GENERACIÓN DE RUTAS DINÁMICAS
export async function getStaticPaths() {
  const { data: services } = await supabase
    .from('services')
    .select('*')
    .eq('active', true);

  return (services || []).map((service) => ({
    params: { slug: service.slug },
    props: { service: service as unknown as Service },
  }));
}

// 2. RECUPERAR DATOS
const { service } = Astro.props;

// 3. MAPA DE RESPALDO (HARDCODED)
// Se usa solo mientras terminas de llenar la base de datos
const fallbackDetails: Record<string, any> = {
  'bartending-eventos': {
    longDesc: "Nuestro servicio insignia diseñado para bodas, aniversarios y celebraciones sociales. Nos encargamos de transformar tu barra en el punto focal de la fiesta con un servicio impecable y cócteles que tus invitados recordarán.",
    idealFor: ["Bodas y Matrimonios", "Cumpleaños (30, 40, 50)", "Aniversarios", "Eventos Privados"],
    includes: ["Cristalería premium completa", "Hielo y todos los insumos", "Limpieza y gestión de residuos"],
    image: "/images/services-hero.png" 
  },
  'bartenders': {
    longDesc: "Contrata a nuestros bartenders profesionales para eventos corporativos y lanzamientos de productos. Perfecto para crear un ambiente sofisticado y ofrecer una experiencia de coctelería de alta calidad que impresione a tus clientes y socios.",
    idealFor: ["Eventos Corporativos", "Lanzamientos de Productos", "Ferias y Exposiciones", "Reuniones de Negocios"],
    includes: ["Bartenders certificados y con experiencia", "Diseño de menú personalizado", "Servicio profesional y elegante", "Asesoría en compra de insumos", "Gestión de residuos y limpieza"],
    image: "/images/services-hero.png" 
  },
  'cocteles-de-autor-y-mixologia': {
    longDesc: "Descubre el mundo de los cócteles de autor con nuestro servicio especializado. Perfecto para eventos exclusivos donde se busca ofrecer una experiencia única y sofisticada. Nuestros mixólogos crearán bebidas innovadoras que sorprenderán a tus invitados.",
    idealFor: ["Eventos Exclusivos", "Lanzamientos de Productos Premium", "Cenas de Gala", "Celebraciones Especiales"],
    includes: ["Cócteles personalizados y exclusivos", "Bartenders expertos en mixología avanzada", "Presentación y garnish de alta gama", "Receta exclusiva creada para ti", "Asesoría en maridaje de bebidas"],
    image: "/images/services-hero.png" 
  },
  'barra-movil': {
    longDesc: "Lleva la experiencia de la coctelería a cualquier lugar con nuestra barra móvil. Ideal para eventos al aire libre, festivales y celebraciones en locaciones únicas. Nuestra barra completamente equipada y nuestro equipo profesional garantizan un servicio excepcional dondequiera que estés.",
    idealFor: ["Eventos al Aire Libre", "Festivales y Ferias", "Celebraciones en Locaciones Únicas", "Bodas en Exteriores"],
    includes: ["Barra móvil completamente equipada", "Cristalería premium completa","Decoración incluida" ,"Setup y desmontaje en el lugar del evento", "Variedad de diseños disponibles", "Cooler para hielo"],
    image: "/images/services-hero.png"
  }
};

const fallback = fallbackDetails[service.slug];

// 4. LÓGICA DE PRIORIDAD (DB > Fallback > Default)
const Icon = ICON_MAP[service.icon as IconName] || ICON_MAP.Martini;
const longDescription = service.long_description || fallback?.longDesc || service.description;
const heroImage = service.image_url || fallback?.image || "/images/services-hero.png";

// Evitamos duplicados: Si la DB tiene features, usamos esos. Si no, los del fallback.
const finalFeatures = (service.features && service.features.length > 0) 
  ? service.features 
  : (fallback?.includes || []);

// Ideal para (actualmente no está en tu interface de DB, así que viene del fallback)
const idealFor = fallback?.idealFor || [];
---

<PageLayout title={`${service.name} | La Reserva`} description={service.description}>
  
  {/* HERO SECTION */}
  <section class="relative h-[50vh] min-h-[400px] flex items-center justify-center overflow-hidden bg-secondary-900">
    <div class="absolute inset-0 z-0">
      <img src={heroImage} alt={service.name} class="w-full h-full object-cover opacity-50" />
      <div class="absolute inset-0 bg-gradient-to-t from-secondary-900 via-secondary-900/60 to-transparent"></div>
    </div>

    <div class="relative z-10 container-custom text-center">
      <div class="inline-flex p-4 rounded-full bg-primary-500/20 text-primary-400 mb-6 backdrop-blur-sm border border-primary-500/30">
        <Icon className="w-8 h-8" />
      </div>
      <h1 class="text-4xl md:text-6xl font-display font-bold text-white mb-4">
        {service.name}
      </h1>
      <p class="text-xl text-secondary-200 max-w-2xl mx-auto">
        {service.description}
      </p>
    </div>
  </section>

  {/* CONTENIDO DETALLADO */}
  <section class="section bg-white">
    <div class="container-custom">
      
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        
        {/* Columna Izquierda: Información */}
        <div class="lg:col-span-8 space-y-12">
          
          {/* Descripción Larga */}
          <div>
            <h2 class="text-2xl font-display font-bold text-secondary-900 mb-4">Sobre el Servicio</h2>
            <p class="text-lg text-secondary-600 leading-relaxed whitespace-pre-line">
              {longDescription}
            </p>
          </div>

          {/* Lo que incluye (Corregido para evitar duplicados) */}
          <div class="bg-secondary-50 p-8 rounded-2xl border border-secondary-100">
            <h3 class="text-xl font-bold text-secondary-900 mb-6">¿Qué incluye esta experiencia?</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {finalFeatures.map((item: string) => (
                <div class="flex items-start gap-3">
                  <CheckCircle2 className="w-5 h-5 text-primary-500 mt-0.5 flex-shrink-0" />
                  <span class="text-secondary-700">{item}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Ideal Para */}
          {idealFor.length > 0 && (
            <div>
              <h3 class="text-xl font-bold text-secondary-900 mb-6">Ideal para</h3>
              <div class="flex flex-wrap gap-3">
                {idealFor.map((tag: string) => (
                  <span class="px-4 py-2 bg-white border border-secondary-200 rounded-full text-secondary-600 text-sm font-medium shadow-sm">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
          )}

        </div>

        {/* Columna Derecha: Sidebar */}
        <div class="lg:col-span-4">
          <div class="sticky top-24 bg-white border border-secondary-200 rounded-2xl p-6 shadow-lg">
            <div class="text-center mb-6 pb-6 border-b border-secondary-100">
              <p class="text-sm text-secondary-500 uppercase tracking-wider mb-2">Inversión desde</p>
              <p class="text-4xl font-bold text-primary-600">{formatCurrency(service.price_from)}</p>
            </div>

            <div class="space-y-4 mb-8">
              <div class="flex items-center gap-3 text-secondary-600">
                <Users className="w-5 h-5 text-primary-500" />
                <span class="text-sm">Capacidad: <strong>{service.guest_range || 'Consultar'} invitados</strong></span>
              </div>
              <div class="flex items-center gap-3 text-secondary-600">
                <Calendar className="w-5 h-5 text-primary-500" />
                <span class="text-sm">Duración base: <strong>{service.duration || 4} horas</strong></span>
              </div>
            </div>

            <Button href="/cotizacion" variant="primary" fullWidth class="mb-4">
              Cotizar este Servicio
            </Button>
            
            <Button href="/servicios" variant="outline" fullWidth class="border-secondary-200 text-secondary-600">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Ver otros servicios
            </Button>
          </div>
        </div>
      </div>

    </div>
  </section>

</PageLayout>